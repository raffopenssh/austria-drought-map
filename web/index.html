<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Austria Drought Risk Map | Municipality-Level Groundwater Analysis</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interactive choropleth map showing drought risk across 2,118 Austrian municipalities based on 100-year groundwater monitoring data and hydropower infrastructure analysis.">
    <meta name="keywords" content="Austria, drought, groundwater, water scarcity, hydropower, climate change, heat pump, municipality, risk map, eHYD, water table">
    <meta name="author" content="Austria Drought Risk Project">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://groundwater-at.exe.xyz:8000/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://groundwater-at.exe.xyz:8000/">
    <meta property="og:title" content="Austria Drought Risk Map">
    <meta property="og:description" content="Interactive map showing drought risk across Austrian municipalities based on 100-year groundwater data and hydropower analysis.">
    <meta property="og:image" content="https://groundwater-at.exe.xyz:8000/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://groundwater-at.exe.xyz:8000/">
    <meta name="twitter:title" content="Austria Drought Risk Map">
    <meta name="twitter:description" content="Interactive map showing drought risk across Austrian municipalities based on 100-year groundwater data.">
    <meta name="twitter:image" content="https://groundwater-at.exe.xyz:8000/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’§</text></svg>">
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Austria Drought Risk Map",
        "description": "Interactive choropleth map showing drought risk across Austrian municipalities",
        "url": "https://groundwater-at.exe.xyz:8000/",
        "applicationCategory": "Environmental Data Visualization",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0"
        },
        "about": {
            "@type": "Thing",
            "name": "Groundwater drought risk in Austria"
        }
    }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
        }
        #header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #0f3460;
        }
        #header h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        #header p {
            font-size: 0.85em;
            color: #a0a0c0;
        }
        #container {
            display: flex;
            height: calc(100vh - 80px);
        }
        #sidebar {
            width: 320px;
            background: #16213e;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }
        #map {
            flex: 1;
            background: #0f0f23;
        }
        .layer-group {
            margin-bottom: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
        }
        .layer-group h3 {
            font-size: 0.9em;
            color: #e94560;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .layer-toggle {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        .layer-toggle input {
            margin-right: 10px;
            accent-color: #e94560;
        }
        .layer-toggle label {
            font-size: 0.85em;
            cursor: pointer;
        }
        .legend {
            margin-top: 15px;
        }
        .legend-title {
            font-size: 0.85em;
            color: #e94560;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.8em;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
        .legend-gradient {
            margin-bottom: 10px;
        }
        .gradient-bar {
            height: 15px;
            background: linear-gradient(to right, #440154, #482878, #3e4989, #31688e, #26828e, #1f9e89, #35b779, #6ece58, #b4de2c, #fde725);
            border-radius: 3px;
        }
        .gradient-bar.hydro-gradient {
            background: linear-gradient(to right, #FFB3B3, #FF8080, #FF4D4D, #CC0000, #990000, #8B0000);
        }
        .gradient-bar.viridis-gradient {
            background: linear-gradient(to right, #fde725, #b4de2c, #6ece58, #35b779, #1f9e89, #26828e, #31688e, #3e4989, #482878, #440154);
        }
        .map-legend {
            background: rgba(22, 33, 62, 0.92);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }
        .map-legend h4 {
            margin: 0 0 6px 0;
            font-size: 11px;
            color: #e94560;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .map-legend .gradient-bar {
            height: 10px;
            width: 120px;
            border-radius: 2px;
        }
        .map-legend .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #a0a0c0;
            margin-top: 2px;
        }
        .map-legend + .map-legend {
            margin-top: 8px;
        }
        .leaflet-bottom.leaflet-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #a0a0c0;
            margin-top: 3px;
        }
        #info-panel {
            margin-top: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
            display: none;
        }
        #info-panel.active {
            display: block;
        }
        #info-panel h4 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #e94560;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #0f3460;
            font-size: 0.85em;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #a0a0c0;
        }
        .info-value {
            font-weight: 500;
        }
        .risk-high { color: #e94560; }
        .risk-medium { color: #f39c12; }
        .risk-low { color: #27ae60; }
        .stats-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .stat {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #e94560;
        }
        .stat-label {
            font-size: 0.75em;
            color: #a0a0c0;
            margin-top: 4px;
        }
        .stat.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .stat.clickable:hover {
            background: #252547;
            transform: scale(1.02);
        }
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }
        .leaflet-popup-tip {
            background: #16213e;
        }
        .popup-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #e94560;
        }
        .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
        }
        .popup-label {
            color: #a0a0c0;
        }
        .footer-links {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #0f3460;
            text-align: center;
            font-size: 0.75em;
        }
        .footer-links a {
            color: #6a6a8a;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #a0a0c0;
        }
        .footer-links .separator {
            margin: 0 8px;
            color: #3a3a5a;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #0f3460;
        }
        .modal h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .modal h3 {
            color: #f39c12;
            margin: 15px 0 8px;
            font-size: 1em;
        }
        .modal p, .modal li {
            color: #a0a0c0;
            font-size: 0.85em;
            line-height: 1.6;
        }
        .modal ul {
            margin-left: 20px;
        }
        .modal a {
            color: #3498db;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #a0a0c0;
            font-size: 1.5em;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #fff;
        }
        .password-form {
            margin-top: 15px;
        }
        .password-form input {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
        }
        .password-form button {
            background: #e94560;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .password-form button:hover {
            background: #c73e54;
        }
        .error-msg {
            color: #e94560;
            font-size: 0.8em;
            margin-top: 8px;
        }
        .municipality-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .municipality-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #0f3460;
            cursor: pointer;
            transition: background 0.2s;
        }
        .municipality-item:hover {
            background: #1a1a2e;
        }
        .municipality-item:last-child {
            border-bottom: none;
        }
        .municipality-name {
            font-weight: 500;
            color: #fff;
        }
        .municipality-score {
            font-size: 0.85em;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .municipality-score.high {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }
        .municipality-score.medium {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h4 {
            font-size: 0.85em;
            color: #e94560;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #0f3460;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .detail-item {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 6px;
        }
        .detail-item .label {
            font-size: 0.75em;
            color: #6a6a8a;
            margin-bottom: 3px;
        }
        .detail-item .value {
            font-size: 1.1em;
            font-weight: 600;
            color: #fff;
        }
        .detail-item .value.risk-high { color: #e94560; }
        .detail-item .value.risk-medium { color: #f39c12; }
        .detail-item .value.risk-low { color: #27ae60; }
        .detail-item .value.declining { color: #fde725; }
        .detail-item .value.rising { color: #440154; }
        .risk-breakdown {
            margin-top: 10px;
        }
        .risk-factor {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .risk-factor-label {
            flex: 1;
            font-size: 0.85em;
            color: #a0a0c0;
        }
        .risk-factor-bar {
            flex: 2;
            height: 8px;
            background: #1a1a2e;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }
        .risk-factor-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .risk-factor-value {
            width: 50px;
            text-align: right;
            font-size: 0.85em;
            font-weight: 600;
        }
        .reasoning-list {
            list-style: none;
            padding: 0;
        }
        .reasoning-list li {
            padding: 8px 0;
            border-bottom: 1px solid #0f3460;
            font-size: 0.85em;
            color: #a0a0c0;
        }
        .reasoning-list li:last-child {
            border-bottom: none;
        }
        .reasoning-list li::before {
            content: 'â€¢';
            color: #e94560;
            margin-right: 8px;
        }
        .zoom-btn {
            background: #e94560;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-top: 15px;
        }
        .zoom-btn:hover {
            background: #c73e54;
        }
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ðŸŒŠ Austria Drought Risk Map</h1>
        <p>Municipality-level analysis of groundwater, hydropower impact, and drought risk indicators</p>
    </div>
    
    <div id="container">
        <div id="sidebar">
            <div class="stats-box">
                <div class="stat">
                    <div class="stat-value" id="stat-municipalities">-</div>
                    <div class="stat-label">Municipalities</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-hydro">-</div>
                    <div class="stat-label">Hydropower Plants</div>
                </div>
                <div class="stat clickable" id="stat-medium-box" title="Click to see medium risk municipalities">
                    <div class="stat-value" id="stat-medium">-</div>
                    <div class="stat-label">Medium Risk</div>
                </div>
                <div class="stat clickable" id="stat-highrisk-box" title="Click to see high risk municipalities">
                    <div class="stat-value" id="stat-highrisk">-</div>
                    <div class="stat-label">High Risk</div>
                </div>
            </div>
            
            <div class="layer-group">
                <h3>Map Layers</h3>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-boundaries" checked>
                    <label for="layer-boundaries">Drought Risk</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-hydro" checked>
                    <label for="layer-hydro">Hydropower Plants</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-gw">
                    <label for="layer-gw">Groundwater Trends</label>
                </div>
            </div>
            
            
            
            <div id="info-panel">
                <h4 id="info-title">Municipality Info</h4>
                <div id="info-content"></div>
            </div>
            
            <div class="footer-links">
                <a href="#" id="sources-link">Sources & Methods</a>
                <span class="separator">â€¢</span>
                <a href="data/austria_drought_risk.gpkg" download>Download GeoPackage</a>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [47.5, 13.5],
            zoom: 7,
            zoomControl: true
        });
        
        // Dark basemap
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18
        }).addTo(map);
        
        // Add map legends container
        const legendContainer = L.control({ position: 'bottomright' });
        legendContainer.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend-container');
            div.id = 'legend-container';
            return div;
        };
        legendContainer.addTo(map);
        
        // Legend state tracking
        const legendState = {
            drought: true,
            hydro: true,
            gw: false
        };
        
        function updateLegends() {
            const container = document.getElementById('legend-container');
            if (!container) return;
            
            let html = '';
            
            if (legendState.gw) {
                html += `
                    <div class="map-legend">
                        <h4>GW Trend</h4>
                        <div class="gradient-bar viridis-gradient"></div>
                        <div class="gradient-labels">
                            <span>-60 (dry)</span>
                            <span>0</span>
                            <span>+30 (wet)</span>
                        </div>
                    </div>
                `;
            }
            
            if (legendState.hydro) {
                html += `
                    <div class="map-legend">
                        <h4>Hydropower</h4>
                        <div class="gradient-bar hydro-gradient"></div>
                        <div class="gradient-labels">
                            <span>0</span>
                            <span>375</span>
                            <span>750 MW</span>
                        </div>
                    </div>
                `;
            }
            
            if (legendState.drought) {
                html += `
                    <div class="map-legend">
                        <h4>Drought Risk</h4>
                        <div class="gradient-bar"></div>
                        <div class="gradient-labels">
                            <span>0%</span>
                            <span>50%</span>
                            <span>100%</span>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Initial legend render
        setTimeout(updateLegends, 100);
        
        // Layer groups - order matters! Bottom to top: boundaries, hydro, gw
        const boundaryLayer = L.layerGroup().addTo(map);
        const hydroLayer = L.layerGroup().addTo(map);
        const gwLayer = L.layerGroup();
        
        // Risk color function (categorical)
        function getRiskColor(risk) {
            if (risk > 0.7) return '#e94560';
            if (risk > 0.4) return '#f39c12';
            return '#27ae60';
        }
        
        // Choropleth color function (gradient)
        function getChoroplethColor(risk) {
            // Viridis color scale: purple (low risk) to yellow (high risk)
            // Using inverted viridis so high risk = yellow (warning)
            const t = Math.max(0, Math.min(1, risk));
            
            const viridis = [
                [68, 1, 84],      // 0.0 - dark purple (low risk)
                [72, 40, 120],    // 0.1
                [62, 74, 137],    // 0.2
                [49, 104, 142],   // 0.3
                [38, 130, 142],   // 0.4
                [31, 158, 137],   // 0.5
                [53, 183, 121],   // 0.6
                [109, 205, 89],   // 0.7
                [180, 222, 44],   // 0.8
                [253, 231, 37]    // 1.0 - yellow (high risk)
            ];
            
            const idx = t * (viridis.length - 1);
            const i = Math.floor(idx);
            const f = idx - i;
            
            if (i >= viridis.length - 1) return `rgb(${viridis[viridis.length-1].join(',')})`;
            
            const r = Math.round(viridis[i][0] + f * (viridis[i+1][0] - viridis[i][0]));
            const g = Math.round(viridis[i][1] + f * (viridis[i+1][1] - viridis[i][1]));
            const b = Math.round(viridis[i][2] + f * (viridis[i+1][2] - viridis[i][2]));
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        function getRiskCategory(risk) {
            if (risk > 0.7) return 'High';
            if (risk > 0.4) return 'Medium';
            return 'Low';
        }
        
        // Hydropower color function - continuous blue scale based on power (MW)
        function getHydroColor(mw) {
            // Scale from light red (low power) to dark red (high power)
            const maxMW = 750;
            const ratio = Math.min(mw / maxMW, 1);
            
            // Interpolate from light red (#FFB3B3) to dark red (#8B0000)
            const r = Math.round(255 - ratio * 116);  // 255 -> 139
            const g = Math.round(179 - ratio * 179);  // 179 -> 0
            const b = Math.round(179 - ratio * 179);  // 179 -> 0
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // Viridis color scale for groundwater trends (inverted)
        // Trend range: approximately -0.6 to +0.3 m/decade
        // Yellow = declining (dry), Purple = rising (wet)
        function getViridisColor(trend) {
            const minTrend = -0.6;
            const maxTrend = 0.3;
            // Invert: declining (negative) = 1 (yellow), rising (positive) = 0 (purple)
            const normalized = (trend - minTrend) / (maxTrend - minTrend);
            const t = 1 - Math.max(0, Math.min(1, normalized)); // Invert the scale
            
            // Viridis colormap approximation
            const viridis = [
                [68, 1, 84],      // 0.0 - dark purple (rising/wet)
                [72, 40, 120],    // 0.1
                [62, 74, 137],    // 0.2
                [49, 104, 142],   // 0.3
                [38, 130, 142],   // 0.4
                [31, 158, 137],   // 0.5
                [53, 183, 121],   // 0.6
                [109, 205, 89],   // 0.7
                [180, 222, 44],   // 0.8
                [253, 231, 37]    // 1.0 - yellow (declining/dry)
            ];
            
            const idx = t * (viridis.length - 1);
            const i = Math.floor(idx);
            const f = idx - i;
            
            if (i >= viridis.length - 1) return `rgb(${viridis[viridis.length-1].join(',')})`;
            
            const r = Math.round(viridis[i][0] + f * (viridis[i+1][0] - viridis[i][0]));
            const g = Math.round(viridis[i][1] + f * (viridis[i+1][1] - viridis[i][1]));
            const b = Math.round(viridis[i][2] + f * (viridis[i+1][2] - viridis[i][2]));
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // Load data
        let municipalitiesData = [];
        let powerplantsData = [];
        let gwStationsData = [];
        let geojsonData = null;
        let sedimentData = [];
        let riverImpactData = [];
        
        async function loadData() {
            try {
                const [muniResp, ppResp, gwResp, geoResp, sedResp, riverResp] = await Promise.all([
                    fetch('data/municipalities.json'),
                    fetch('data/powerplants.json'),
                    fetch('data/gw_stations_trends.json'),
                    fetch('data/municipalities_risk.geojson'),
                    fetch('data/sediment_analysis.json'),
                    fetch('data/river_hydro_impact.json')
                ]);
                
                municipalitiesData = await muniResp.json();
                powerplantsData = await ppResp.json();
                gwStationsData = await gwResp.json();
                geojsonData = await geoResp.json();
                sedimentData = await sedResp.json();
                const riverData = await riverResp.json();
                riverImpactData = riverData.river_impacts || [];
                
                updateStats();
                renderLayers();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        function updateStats() {
            document.getElementById('stat-municipalities').textContent = municipalitiesData.length;
            document.getElementById('stat-hydro').textContent = powerplantsData.length;
            
            // Count risk categories
            const highRisk = municipalitiesData.filter(m => m.risk_category === 'high').length;
            const medRisk = municipalitiesData.filter(m => m.risk_category === 'medium').length;
            document.getElementById('stat-medium').textContent = medRisk;
            document.getElementById('stat-highrisk').textContent = highRisk;
        }
        
        function renderLayers() {
            // Clear layers
            hydroLayer.clearLayers();
            boundaryLayer.clearLayers();
            gwLayer.clearLayers();
            
            // Render choropleth - municipalities colored by risk score
            if (geojsonData) {
                L.geoJSON(geojsonData, {
                    style: function(feature) {
                        const risk = feature.properties.risk_score || 0;
                        return {
                            fillColor: getChoroplethColor(risk),
                            fillOpacity: 0.75,
                            color: '#1a1a2e',
                            weight: 0.5
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const risk = props.risk_score || 0;
                        const gwTrend = props.gw_trend ? (props.gw_trend * 100).toFixed(1) + ' cm/dec' : 'N/A';
                        
                        layer.bindTooltip(`
                            <b>${props.name}</b><br>
                            Risk: ${(risk * 100).toFixed(0)}%<br>
                            GW Trend: ${gwTrend}
                        `, { sticky: true });
                        
                        layer.on('click', function() {
                            showMunicipalityDetailModal(props.name);
                        });
                        
                        layer.on('mouseover', function() {
                            layer.setStyle({ 
                                fillOpacity: 0.9,
                                weight: 2,
                                color: '#fff'
                            });
                            layer.bringToFront();
                        });
                        
                        layer.on('mouseout', function() {
                            layer.setStyle({ 
                                fillOpacity: 0.75,
                                weight: 0.5,
                                color: '#1a1a2e'
                            });
                        });
                    }
                }).addTo(boundaryLayer);
            }
            
            // Render hydropower plants - uniform size, color by power
            powerplantsData.forEach(pp => {
                const marker = L.circleMarker([pp.lat, pp.lon], {
                    radius: 6,
                    fillColor: getHydroColor(pp.mw || 0),
                    fillOpacity: 0.9,
                    color: '#fff',
                    weight: 1
                });
                
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showHydroDetailModal(pp);
                });
                
                marker.bindTooltip(`${pp.name || pp.type}: ${pp.mw} MW`, { direction: 'top' });
                
                marker.addTo(hydroLayer);
            });
            
            // Render groundwater stations with trend coloring (viridis)
            gwStationsData.forEach(gw => {
                if (!gw.lat || !gw.lon) return;
                const trend = gw.trend_m_per_decade;
                if (trend === undefined || trend === null) return;
                
                const marker = L.circleMarker([gw.lat, gw.lon], {
                    radius: 5,
                    fillColor: getViridisColor(trend),
                    fillOpacity: 0.85,
                    color: '#222',
                    weight: 0.5
                });
                
                const trendCm = (trend * 100).toFixed(1);
                const trendDir = trend < 0 ? 'declining' : 'rising';
                
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    showGWStationDetailModal(gw);
                });
                
                marker.bindTooltip(`${gw.name || 'GW Station'}: ${trendCm} cm/dec`, { direction: 'top' });
                
                marker.addTo(gwLayer);
            });
        }
        
        function showMunicipalityInfo(props) {
            const panel = document.getElementById('info-panel');
            const title = document.getElementById('info-title');
            const content = document.getElementById('info-content');
            
            title.textContent = props.name || 'Unknown';
            
            const riskClass = props.risk_score > 0.7 ? 'risk-high' : 
                             props.risk_score > 0.4 ? 'risk-medium' : 'risk-low';
            
            const gwTrend = props.gw_trend ? (props.gw_trend * 100).toFixed(1) : 'N/A';
            const gwTrendClass = props.gw_trend < 0 ? 'risk-high' : 'risk-low';
            
            content.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Risk Score:</span>
                    <span class="info-value ${riskClass}">${(props.risk_score * 100 || 0).toFixed(1)}%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Risk Category:</span>
                    <span class="info-value ${riskClass}">${props.risk_category || 'low'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">GW Trend:</span>
                    <span class="info-value ${gwTrendClass}">${gwTrend} cm/decade</span>
                </div>
                <div class="info-row">
                    <span class="info-label">GW Stations:</span>
                    <span class="info-value">${props.gw_stations || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hydro Plants:</span>
                    <span class="info-value">${props.hydro_plants || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hydro Capacity:</span>
                    <span class="info-value">${props.hydro_capacity || 0} MW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Pump Storage:</span>
                    <span class="info-value">${props.pump_storage || 0} MW</span>
                </div>
            `;
            
            panel.classList.add('active');
        }
        
        // Layer toggle handlers
        document.getElementById('layer-hydro').addEventListener('change', function() {
            if (this.checked) map.addLayer(hydroLayer);
            else map.removeLayer(hydroLayer);
            legendState.hydro = this.checked;
            updateLegends();
        });
        
        document.getElementById('layer-boundaries').addEventListener('change', function() {
            if (this.checked) map.addLayer(boundaryLayer);
            else map.removeLayer(boundaryLayer);
            legendState.drought = this.checked;
            updateLegends();
        });
        
        document.getElementById('layer-gw').addEventListener('change', function() {
            if (this.checked) map.addLayer(gwLayer);
            else map.removeLayer(gwLayer);
            legendState.gw = this.checked;
            updateLegends();
        });
        
        // Stats click handlers
        document.getElementById('stat-medium-box').addEventListener('click', function() {
            showRiskListModal('medium');
        });
        
        document.getElementById('stat-highrisk-box').addEventListener('click', function() {
            showRiskListModal('high');
        });
        
        function showRiskListModal(riskLevel) {
            const modal = document.getElementById('risk-list-modal');
            const title = document.getElementById('risk-list-title');
            const list = document.getElementById('risk-list-content');
            
            const filtered = municipalitiesData
                .filter(m => m.risk_category === riskLevel)
                .sort((a, b) => (b.risk_score || 0) - (a.risk_score || 0));
            
            const labelClass = riskLevel === 'high' ? 'high' : 'medium';
            const labelText = riskLevel === 'high' ? 'High Risk' : 'Medium Risk';
            
            title.textContent = `${labelText} Municipalities (${filtered.length})`;
            
            let html = '<div class="municipality-list">';
            filtered.forEach(m => {
                const score = ((m.risk_score || 0) * 100).toFixed(0);
                html += `
                    <div class="municipality-item" data-name="${m.name}" onclick="showMunicipalityDetailModal('${m.name.replace(/'/g, "\\'")}')">
                        <span class="municipality-name">${m.name}</span>
                        <span class="municipality-score ${labelClass}">${score}%</span>
                    </div>
                `;
            });
            html += '</div>';
            
            list.innerHTML = html;
            modal.classList.add('active');
        }
        
        // Point-in-polygon check using ray casting algorithm
        function pointInPolygon(point, polygon) {
            const [x, y] = point;
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const [xi, yi] = polygon[i];
                const [xj, yj] = polygon[j];
                
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }
        
        // Check if point is in any polygon of a GeoJSON feature (handles MultiPolygon)
        function pointInFeature(lat, lon, feature) {
            if (!feature || !feature.geometry) return false;
            const point = [lon, lat]; // GeoJSON uses [lon, lat]
            
            if (feature.geometry.type === 'Polygon') {
                return pointInPolygon(point, feature.geometry.coordinates[0]);
            } else if (feature.geometry.type === 'MultiPolygon') {
                return feature.geometry.coordinates.some(poly => pointInPolygon(point, poly[0]));
            }
            return false;
        }
        
        function showMunicipalityDetailModal(name) {
            // Find municipality data
            const muni = municipalitiesData.find(m => m.name === name);
            if (!muni) return;
            
            // Find GeoJSON feature for bounds
            let feature = null;
            if (geojsonData) {
                feature = geojsonData.features.find(f => f.properties.name === name);
            }
            
            const modal = document.getElementById('municipality-detail-modal');
            const title = document.getElementById('detail-muni-title');
            const content = document.getElementById('detail-muni-content');
            
            title.textContent = name;
            
            // Find GW stations actually inside this municipality's polygon
            const stationsInMuni = feature ? gwStationsData.filter(s => 
                s.lat && s.lon && pointInFeature(s.lat, s.lon, feature)
            ) : [];
            
            // Filter to those with trend data
            const stationsWithTrends = stationsInMuni.filter(s => s.trend_m_per_decade !== undefined);
            
            // Check if municipality has direct GW monitoring
            const hasDirectGW = stationsInMuni.length > 0;
            const hasGWTrend = stationsWithTrends.length > 0;
            
            // Calculate average trend from stations in municipality
            let avgTrendInMuni = null;
            if (hasGWTrend) {
                avgTrendInMuni = stationsWithTrends.reduce((sum, s) => sum + s.trend_m_per_decade, 0) / stationsWithTrends.length;
            }
            
            // Find nearby GW stations for context (outside municipality)
            const nearbyStations = gwStationsData
                .filter(s => s.trend_m_per_decade !== undefined && !stationsInMuni.includes(s))
                .map(s => ({
                    ...s,
                    dist: Math.sqrt(Math.pow(s.lat - muni.lat, 2) + Math.pow(s.lon - muni.lon, 2))
                }))
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 5);
            
            // Calculate risk factors - use actual trend from stations in municipality if available
            const gwTrend = hasGWTrend ? avgTrendInMuni : (muni.gw_trend !== undefined ? muni.gw_trend : null);
            
            // Calculate GW decline factor based on:
            // 1. Percentage of stations with declining trends
            // 2. Severity of decline (median of negative trends)
            let gwFactor = 0;
            if (hasGWTrend && stationsWithTrends.length > 0) {
                const decliningStations = stationsWithTrends.filter(s => s.trend_m_per_decade < 0);
                const decliningPct = decliningStations.length / stationsWithTrends.length;
                
                // Get median decline rate (only negative trends)
                let medianDecline = 0;
                if (decliningStations.length > 0) {
                    const declines = decliningStations.map(s => s.trend_m_per_decade).sort((a, b) => a - b);
                    const mid = Math.floor(declines.length / 2);
                    medianDecline = declines.length % 2 ? declines[mid] : (declines[mid - 1] + declines[mid]) / 2;
                }
                
                // Combine: % declining * severity factor
                // Severity: -0.1 m/dec (-10cm) = 50% severity, -0.2 m/dec = 100%
                const severityFactor = Math.min(Math.abs(medianDecline) / 0.2, 1);
                gwFactor = decliningPct * 50 + severityFactor * 50;  // Max 100%
            } else if (gwTrend !== null && gwTrend < 0) {
                // Fallback for interpolated data
                gwFactor = Math.min(Math.abs(gwTrend) / 0.2, 1) * 100;
            }
            
            // Hydropower impact: scale 0-100% based on capacity
            // 1000 MW = 100% (99th percentile of Austrian municipalities)
            const hydroFactor = (muni.hydro_factor || 0) * 100;  // Use pre-calculated hydro_factor
            const precipFactor = (muni.precip_risk || 0) * 100;  // Precipitation decline risk
            const riskScore = (muni.risk_score || 0) * 100;
            
            // Find nearby hydropower plants and their rivers
            const nearbyPlants = powerplantsData
                .map(p => ({
                    ...p,
                    dist: Math.sqrt(Math.pow(p.lat - muni.lat, 2) + Math.pow(p.lon - muni.lon, 2)) * 111
                }))
                .filter(p => p.dist <= 30)
                .sort((a, b) => a.dist - b.dist);
            
            // Get unique rivers from nearby plants
            const nearbyRivers = [...new Set(nearbyPlants.map(p => p.river).filter(r => r && r !== '-'))];
            
            // Get river impact data for these rivers
            const riverInfo = nearbyRivers.map(r => {
                const impact = riverImpactData.find(ri => ri.river === r);
                return impact ? { name: r, ...impact } : { name: r, total_mw: 0, plant_count: 0 };
            }).sort((a, b) => b.total_mw - a.total_mw).slice(0, 4);
            
            // Find nearby sediment stations (very rough coordinate matching)
            // Note: sediment data doesn't have coords, so we match via river names
            const nearbySediment = sedimentData
                .filter(s => nearbyRivers.includes(s.river))
                .sort((a, b) => b.mean_daily_t - a.mean_daily_t)
                .slice(0, 3);
            
            const riskClass = muni.risk_score > 0.7 ? 'risk-high' : muni.risk_score > 0.4 ? 'risk-medium' : 'risk-low';
            const gwClass = gwTrend !== null ? (gwTrend < 0 ? 'declining' : 'rising') : '';
            
            // Build reasoning
            const reasons = [];
            
            if (hasDirectGW) {
                reasons.push(`${stationsInMuni.length} groundwater monitoring station(s) in municipality`);
                if (hasGWTrend) {
                    if (gwTrend < -0.1) reasons.push(`Average trend: ${(gwTrend * 100).toFixed(1)} cm/decade (declining)`);
                    else if (gwTrend < 0) reasons.push(`Average trend: ${(gwTrend * 100).toFixed(1)} cm/decade (slight decline)`);
                    else if (gwTrend > 0.1) reasons.push(`Average trend: +${(gwTrend * 100).toFixed(1)} cm/decade (rising)`);
                    else reasons.push(`Average trend: ${(gwTrend * 100).toFixed(1)} cm/decade (stable)`);
                } else {
                    reasons.push(`${stationsInMuni.length - stationsWithTrends.length} station(s) without trend data`);
                }
            } else {
                reasons.push('No groundwater monitoring stations in this municipality');
                if (nearbyStations.length > 0) {
                    const avgTrend = nearbyStations.reduce((sum, s) => sum + s.trend_m_per_decade, 0) / nearbyStations.length;
                    const avgDist = nearbyStations.reduce((sum, s) => sum + s.dist, 0) / nearbyStations.length * 111; // rough km
                    reasons.push(`Nearest ${nearbyStations.length} stations (avg ${avgDist.toFixed(0)}km away) show ${avgTrend < 0 ? 'declining' : 'stable/rising'} trend`);
                }
            }
            
            if ((muni.hydro_capacity || 0) > 100) reasons.push(`High hydropower capacity (${muni.hydro_capacity} MW) may affect local hydrology`);
            else if ((muni.hydro_plants || 0) > 0) reasons.push(`${muni.hydro_plants} hydropower plant(s) with ${muni.hydro_capacity || 0} MW capacity`);
            else reasons.push('No significant hydropower infrastructure');
            
            if ((muni.pump_storage || 0) > 0) reasons.push(`${muni.pump_storage} MW pump storage capacity (water cycling)`);
            
            // Build stations HTML - either in municipality or nearby
            let stationsHtml = '';
            if (hasDirectGW && stationsInMuni.length > 0) {
                // Show stations inside the municipality
                stationsHtml = `
                    <div class="detail-section">
                        <h4>Groundwater Stations in Municipality</h4>
                        <div class="municipality-list" style="max-height: 150px;">
                            ${stationsInMuni.map(s => {
                                const hasTrend = s.trend_m_per_decade !== undefined;
                                const trendCm = hasTrend ? (s.trend_m_per_decade * 100).toFixed(1) : 'N/A';
                                const trendClass = hasTrend ? (s.trend_m_per_decade < -0.1 ? 'high' : 'medium') : '';
                                return `
                                    <div class="municipality-item" style="padding: 6px 8px;" onclick="showGWStationDetailModal(gwStationsData.find(g => g.id === '${s.id}'))">
                                        <span class="municipality-name" style="font-size: 0.8em;">${s.name || 'Station ' + s.id}</span>
                                        <span class="municipality-score ${trendClass}" style="font-size: 0.75em;">${trendCm}${hasTrend ? ' cm/dec' : ''}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else if (!hasDirectGW && nearbyStations.length > 0) {
                // Show nearby stations
                stationsHtml = `
                    <div class="detail-section">
                        <h4>Nearby Groundwater Stations</h4>
                        <p style="font-size: 0.8em; color: #6a6a8a; margin-bottom: 10px;">No stations in municipality - showing nearest monitoring points:</p>
                        <div class="municipality-list" style="max-height: 150px;">
                            ${nearbyStations.map(s => {
                                const trendCm = (s.trend_m_per_decade * 100).toFixed(1);
                                const distKm = (s.dist * 111).toFixed(1);
                                const trendClass = s.trend_m_per_decade < -0.1 ? 'high' : 'medium';
                                return `
                                    <div class="municipality-item" style="padding: 6px 8px;" onclick="showGWStationDetailModal(gwStationsData.find(g => g.id === '${s.id}'))">
                                        <span class="municipality-name" style="font-size: 0.8em;">${s.name || 'Station ' + s.id}</span>
                                        <span style="font-size: 0.75em; color: #6a6a8a;">${distKm}km</span>
                                        <span class="municipality-score ${trendClass}" style="font-size: 0.75em;">${trendCm} cm/dec</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="detail-section">
                    <h4>Risk Overview</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Risk Score</div>
                            <div class="value ${riskClass}">${riskScore.toFixed(1)}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Category</div>
                            <div class="value ${riskClass}">${muni.risk_category || 'low'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">GW Trend</div>
                            <div class="value ${gwClass}">${gwTrend !== null ? (gwTrend * 100).toFixed(1) + ' cm/dec' : 'No data'}${!hasDirectGW ? ' *' : ''}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Monitoring Stations</div>
                            <div class="value">${stationsInMuni.length}${hasGWTrend ? ` (${stationsWithTrends.length} with data)` : ''}</div>
                        </div>
                    </div>
                    ${!hasDirectGW ? '<p style="font-size: 0.7em; color: #6a6a8a; margin-top: 8px;">* Estimated from nearby stations</p>' : ''}
                </div>
                
                <div class="detail-section">
                    <h4>Risk Factors</h4>
                    <div class="risk-breakdown">
                        <div class="risk-factor">
                            <span class="risk-factor-label">Groundwater Decline</span>
                            <div class="risk-factor-bar">
                                <div class="risk-factor-fill" style="width: ${gwFactor}%; background: ${gwFactor > 50 ? '#e94560' : gwFactor > 25 ? '#f39c12' : '#27ae60'}"></div>
                            </div>
                            <span class="risk-factor-value" style="color: ${gwFactor > 50 ? '#e94560' : gwFactor > 25 ? '#f39c12' : '#27ae60'}">${gwFactor.toFixed(0)}%</span>
                        </div>
                        <div class="risk-factor">
                            <span class="risk-factor-label">Hydropower Impact</span>
                            <div class="risk-factor-bar">
                                <div class="risk-factor-fill" style="width: ${hydroFactor}%; background: ${hydroFactor > 50 ? '#e94560' : hydroFactor > 25 ? '#f39c12' : '#27ae60'}"></div>
                            </div>
                            <span class="risk-factor-value" style="color: ${hydroFactor > 50 ? '#e94560' : hydroFactor > 25 ? '#f39c12' : '#27ae60'}">${hydroFactor.toFixed(0)}%</span>
                        </div>
                        <div class="risk-factor">
                            <span class="risk-factor-label">Precipitation Decline</span>
                            <div class="risk-factor-bar">
                                <div class="risk-factor-fill" style="width: ${precipFactor}%; background: ${precipFactor > 50 ? '#e94560' : precipFactor > 25 ? '#f39c12' : '#27ae60'}"></div>
                            </div>
                            <span class="risk-factor-value" style="color: ${precipFactor > 50 ? '#e94560' : precipFactor > 25 ? '#f39c12' : '#27ae60'}">${precipFactor.toFixed(0)}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Infrastructure & Climate</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Hydropower Plants</div>
                            <div class="value">${muni.hydro_plants || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Total Capacity</div>
                            <div class="value">${muni.hydro_capacity || 0} MW</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">GW Stations</div>
                            <div class="value">${stationsInMuni.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Precip Stations</div>
                            <div class="value">${muni.precip_stations || 0}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Mean Precipitation</div>
                            <div class="value">${muni.precip_mean_mm ? muni.precip_mean_mm + ' mm/yr' : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Precip Trend</div>
                            <div class="value" style="color: ${muni.precip_trend_mm < -20 ? '#e94560' : muni.precip_trend_mm < 0 ? '#f39c12' : '#27ae60'}">${muni.precip_trend_mm ? (muni.precip_trend_mm > 0 ? '+' : '') + muni.precip_trend_mm.toFixed(0) + ' mm/dec' : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${riverInfo.length > 0 ? `
                <div class="detail-section">
                    <h4>Nearby Rivers & Hydropower</h4>
                    <div class="stations-list" style="max-height: 150px;">
                        ${riverInfo.map(r => {
                            const impactClass = r.total_mw > 500 ? 'high' : r.total_mw > 100 ? 'medium' : 'low';
                            return `
                                <div class="municipality-item" style="padding: 6px 8px; display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center;">
                                    <span class="municipality-name" style="font-size: 0.85em;">${r.name}</span>
                                    <span style="font-size: 0.75em; color: #6a6a8a; text-align: right;">${r.plant_count} plants</span>
                                    <span class="municipality-score ${impactClass}" style="font-size: 0.75em; min-width: 70px; text-align: right;">${r.total_mw.toFixed(0)} MW</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${nearbySediment.length > 0 ? `
                <div class="detail-section">
                    <h4>Sediment Transport</h4>
                    <div class="stations-list" style="max-height: 130px;">
                        ${nearbySediment.map(s => {
                            const trendClass = s.trend_pct < -20 ? 'high' : s.trend_pct < 0 ? 'medium' : 'low';
                            return `
                                <div class="municipality-item" style="padding: 6px 8px; display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center;">
                                    <span class="municipality-name" style="font-size: 0.85em;">${s.station}</span>
                                    <span style="font-size: 0.75em; color: #6a6a8a; text-align: right;">${s.river}</span>
                                    <span class="municipality-score ${trendClass}" style="font-size: 0.75em; min-width: 50px; text-align: right;" title="${s.mean_daily_t.toFixed(0)} t/day avg">${s.trend_pct > 0 ? '+' : ''}${s.trend_pct.toFixed(0)}%</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <p style="font-size: 0.7em; color: #6a6a8a; margin-top: 8px;">Declining sediment may indicate upstream dam trapping</p>
                </div>
                ` : ''}
                
                ${stationsHtml}
                
                <div class="detail-section">
                    <h4>Assessment Reasoning</h4>
                    <ul class="reasoning-list">
                        ${reasons.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
                
                <button class="zoom-btn" onclick="zoomToMunicipality('${name.replace(/'/g, "\\'")}')">
                    ðŸ“ Zoom to Location
                </button>
            `;
            
            modal.classList.add('active');
        }
        
        function showHydroDetailModal(pp) {
            const modal = document.getElementById('hydro-detail-modal');
            const title = document.getElementById('hydro-detail-title');
            const content = document.getElementById('hydro-detail-content');
            
            title.textContent = pp.name || pp.type || 'Hydropower Plant';
            
            const capacityClass = pp.mw > 500 ? 'risk-high' : pp.mw > 100 ? 'risk-medium' : 'risk-low';
            
            content.innerHTML = `
                <div class="detail-section">
                    <h4>Plant Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Type</div>
                            <div class="value">${pp.type || 'Hydropower'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Capacity</div>
                            <div class="value ${capacityClass}">${pp.mw || 0} MW</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">River</div>
                            <div class="value">${pp.river || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Region</div>
                            <div class="value">${pp.region || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Location</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Latitude</div>
                            <div class="value">${pp.lat?.toFixed(5) || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Longitude</div>
                            <div class="value">${pp.lon?.toFixed(5) || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Impact Assessment</h4>
                    <ul class="reasoning-list">
                        <li>${pp.mw > 500 ? 'Large-scale facility with significant water usage' : pp.mw > 100 ? 'Medium-scale facility with moderate water usage' : 'Small-scale facility with limited water impact'}</li>
                        <li>${pp.type?.includes('Pump') || pp.type?.includes('pump') ? 'Pump storage: water is cycled, net consumption lower' : 'Run-of-river or reservoir: continuous water flow impact'}</li>
                        ${pp.river ? `<li>Located on ${pp.river}</li>` : ''}
                    </ul>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function showGWStationDetailModal(gw) {
            const modal = document.getElementById('gw-detail-modal');
            const title = document.getElementById('gw-detail-title');
            const content = document.getElementById('gw-detail-content');
            
            title.textContent = gw.name || 'Groundwater Station';
            
            const trend = gw.trend_m_per_decade || 0;
            const trendCm = (trend * 100).toFixed(1);
            const trendClass = trend < -0.1 ? 'declining' : trend > 0.1 ? 'rising' : '';
            const trendStatus = trend < -0.1 ? 'Declining' : trend > 0.1 ? 'Rising' : 'Stable';
            
            content.innerHTML = `
                <div class="detail-section">
                    <h4>Trend Analysis</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Trend</div>
                            <div class="value ${trendClass}">${trendCm} cm/decade</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Status</div>
                            <div class="value ${trendClass}">${trendStatus}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Data Years</div>
                            <div class="value">${gw.data_years ? gw.data_years.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">P-Value</div>
                            <div class="value">${gw.p_value ? gw.p_value.toFixed(4) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Water Levels</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Mean Level</div>
                            <div class="value">${gw.mean_level ? gw.mean_level.toFixed(2) + ' m' : 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Current Level</div>
                            <div class="value">${gw.current_level ? gw.current_level.toFixed(2) + ' m' : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Station Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Station ID</div>
                            <div class="value">${gw.id || gw.station_id || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Area Code</div>
                            <div class="value">${gw.area || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Latitude</div>
                            <div class="value">${gw.lat?.toFixed(5) || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Longitude</div>
                            <div class="value">${gw.lon?.toFixed(5) || 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>Interpretation</h4>
                    <ul class="reasoning-list">
                        <li>${trend < -0.1 ? 'Significant declining trend indicates potential groundwater depletion' : trend > 0.1 ? 'Rising trend suggests good groundwater recharge' : 'Stable water table indicates balanced recharge and extraction'}</li>
                        <li>${gw.p_value && gw.p_value < 0.05 ? 'Trend is statistically significant (p < 0.05)' : 'Trend may not be statistically significant'}</li>
                        <li>${gw.data_years && gw.data_years > 20 ? 'Long-term monitoring provides reliable trend data' : 'Limited data history - trend should be interpreted with caution'}</li>
                    </ul>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function zoomToMunicipality(name) {
            if (!geojsonData) return;
            const feature = geojsonData.features.find(f => f.properties.name === name);
            if (feature) {
                const layer = L.geoJSON(feature);
                map.fitBounds(layer.getBounds(), { padding: [50, 50] });
                // Close modals
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            }
        }
        
        // Load data on page load
        loadData();
        
        // Modal handlers
        document.getElementById('sources-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('sources-modal').classList.add('active');
        });
        
        // Use event delegation for modal close buttons and overlay clicks
        document.addEventListener('click', function(e) {
            // Close on X button click
            if (e.target.classList.contains('modal-close')) {
                e.target.closest('.modal-overlay').classList.remove('active');
            }
            // Close on overlay click (outside modal)
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });
        
        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
        
        
    </script>
    
    <!-- Risk List Modal -->
    <div class="modal-overlay" id="risk-list-modal">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2 id="risk-list-title">Risk Municipalities</h2>
            <p style="color: #6a6a8a; font-size: 0.85em; margin-bottom: 15px;">Click on a municipality to see detailed analysis</p>
            <div id="risk-list-content"></div>
        </div>
    </div>
    
    <!-- Municipality Detail Modal -->
    <div class="modal-overlay" id="municipality-detail-modal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close">&times;</button>
            <h2 id="detail-muni-title">Municipality Details</h2>
            <div id="detail-muni-content" style="max-height: 65vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Hydropower Detail Modal -->
    <div class="modal-overlay" id="hydro-detail-modal">
        <div class="modal" style="max-width: 450px;">
            <button class="modal-close">&times;</button>
            <h2 id="hydro-detail-title">Hydropower Plant</h2>
            <div id="hydro-detail-content"></div>
        </div>
    </div>
    
    <!-- Groundwater Station Detail Modal -->
    <div class="modal-overlay" id="gw-detail-modal">
        <div class="modal" style="max-width: 450px;">
            <button class="modal-close">&times;</button>
            <h2 id="gw-detail-title">Groundwater Station</h2>
            <div id="gw-detail-content"></div>
        </div>
    </div>
    
    <!-- Sources Modal -->
    <div class="modal-overlay" id="sources-modal">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>Sources & Methods</h2>
            
            <h3>Data Sources</h3>
            <ul>
                <li><a href="https://ehyd.gv.at" target="_blank">eHYD Portal</a> - Austrian hydrographic service
                    <ul>
                        <li>Groundwater levels (2,074 monitoring stations)</li>
                        <li>Surface water stations (795 OWF stations on 469 rivers)</li>
                        <li>Sediment transport (34 stations with daily measurements)</li>
                        <li>Precipitation (861 stations with daily data since 1971)</li>
                        <li>100+ years of measurements</li>
                    </ul>
                </li>
                <li><a href="https://oesterreichsenergie.at" target="_blank">Oesterreichs Energie</a> - Power plant registry (156 hydropower plants)</li>
                <li>Municipality boundaries from <a href="https://github.com/ginseng666/GeoJSON-TopoJSON-Austria" target="_blank">GeoJSON Austria</a></li>
            </ul>
            
            <h3>Risk Calculation</h3>
            <p>The drought risk score combines three factors:</p>
            <ul>
                <li><b>Groundwater trend (40%)</b>: Linear regression on annual mean water table levels. Negative trends (declining water table) increase risk.</li>
                <li><b>Hydropower impact (30%)</b>: Weighted impact of nearby plants within 30km radius (see below).</li>
                <li><b>Precipitation trend (30%)</b>: Long-term precipitation trends from nearby stations. Declining precipitation increases drought risk.</li>
            </ul>
            
            <h3>Hydropower Impact Factor</h3>
            <p>The hydro_factor calculation considers:</p>
            <ul>
                <li><b>Proximity</b>: Plants within 30km radius, with distance decay (closer = more impact)</li>
                <li><b>Plant type weights</b>:
                    <ul>
                        <li>Storage (Speicherkraftwerk): 0.7 - major sediment trapping</li>
                        <li>Pumped storage (Pumpspeicherkraftwerk): 0.5 - moderate impact</li>
                        <li>Run-of-river (Laufkraftwerk): 0.3 - lower sediment impact</li>
                    </ul>
                </li>
                <li><b>Sediment trends</b>: Declining sediment transport indicates upstream dam trapping, used as modifier</li>
                <li>Normalized to 500 MW weighted impact = 100%</li>
            </ul>
            
            <h3>River Network Analysis</h3>
            <ul>
                <li>469 rivers identified from surface water monitoring network</li>
                <li>Major rivers by hydropower: Donau (2,254 MW), Ill (2,237 MW), Inn (1,294 MW)</li>
                <li>Hydropower aggregated by river for impact assessment</li>
            </ul>
            
            <h3>Sediment Transport Analysis</h3>
            <ul>
                <li>34 sediment monitoring stations analyzed</li>
                <li>Trend calculated: recent 3-year average vs. historical 3-year average</li>
                <li>Declining trends may indicate upstream dam sediment trapping</li>
                <li>Example findings:
                    <ul>
                        <li>Enns at Steyr: -64% decline</li>
                        <li>Inn at SchÃ¤rding: 12,674 t/day average</li>
                        <li>Salzach at Ach: +98% increase</li>
                    </ul>
                </li>
            </ul>
            
            <h3>Precipitation Trend Analysis</h3>
            <ul>
                <li>861 precipitation stations analyzed (daily data since 1971)</li>
                <li>Annual totals calculated (minimum 300 days/year required)</li>
                <li>Linear trend over 10+ years, outliers removed</li>
                <li>Risk factor: -100 mm/decade = 100% risk, +100 mm/decade = 0% risk</li>
                <li>Distance-weighted average from stations within 30km</li>
                <li>Finding: 231/861 stations show declining precipitation</li>
                <li>Example trends:
                    <ul>
                        <li>ZÃ¼rs-Hexenboden: -449 mm/decade (Alpine decline)</li>
                        <li>PfÃ¤nder: +313 mm/decade (Lake Constance increase)</li>
                        <li>Mean trend: +9 mm/decade</li>
                    </ul>
                </li>
            </ul>
            
            <h3>Groundwater Trend Analysis</h3>
            <ul>
                <li>Minimum 10 years of data required</li>
                <li>Outliers filtered (trends > 5m/decade excluded)</li>
                <li>Stations with unrealistic variance excluded</li>
                <li>Result: 94 stations with valid trends</li>
                <li>Finding: 54 declining, 40 rising (mean: -4.7cm/decade)</li>
            </ul>
            
            <h3>Limitations</h3>
            <ul>
                <li>Coordinate transformation (BMN to WGS84) is approximate</li>
                <li>Risk interpolated to municipalities without direct monitoring</li>
                <li>Hydropower impact is proximity-based, not fully hydrologically modeled</li>
                <li>Sediment stations matched to municipalities via river names (no direct coordinates)</li>
                <li>River connectivity not modeled (upstream/downstream relationships)</li>
            </ul>
        </div>
    </div>
    
    
</body>
</html>
