<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Austria Drought Risk Map | Municipality-Level Groundwater Analysis</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Interactive choropleth map showing drought risk across 2,118 Austrian municipalities based on 100-year groundwater monitoring data and hydropower infrastructure analysis.">
    <meta name="keywords" content="Austria, drought, groundwater, water scarcity, hydropower, climate change, heat pump, municipality, risk map, eHYD, water table">
    <meta name="author" content="Austria Drought Risk Project">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://groundwater-at.exe.xyz:8000/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://groundwater-at.exe.xyz:8000/">
    <meta property="og:title" content="Austria Drought Risk Map">
    <meta property="og:description" content="Interactive map showing drought risk across Austrian municipalities based on 100-year groundwater data and hydropower analysis.">
    <meta property="og:image" content="https://groundwater-at.exe.xyz:8000/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://groundwater-at.exe.xyz:8000/">
    <meta name="twitter:title" content="Austria Drought Risk Map">
    <meta name="twitter:description" content="Interactive map showing drought risk across Austrian municipalities based on 100-year groundwater data.">
    <meta name="twitter:image" content="https://groundwater-at.exe.xyz:8000/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’§</text></svg>">
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Austria Drought Risk Map",
        "description": "Interactive choropleth map showing drought risk across Austrian municipalities",
        "url": "https://groundwater-at.exe.xyz:8000/",
        "applicationCategory": "Environmental Data Visualization",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0"
        },
        "about": {
            "@type": "Thing",
            "name": "Groundwater drought risk in Austria"
        }
    }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
        }
        #header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 15px 20px;
            border-bottom: 1px solid #0f3460;
        }
        #header h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        #header p {
            font-size: 0.85em;
            color: #a0a0c0;
        }
        #container {
            display: flex;
            height: calc(100vh - 80px);
        }
        #sidebar {
            width: 320px;
            background: #16213e;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }
        #map {
            flex: 1;
            background: #0f0f23;
        }
        .layer-group {
            margin-bottom: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
        }
        .layer-group h3 {
            font-size: 0.9em;
            color: #e94560;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .layer-toggle {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
        }
        .layer-toggle input {
            margin-right: 10px;
            accent-color: #e94560;
        }
        .layer-toggle label {
            font-size: 0.85em;
            cursor: pointer;
        }
        .legend {
            margin-top: 15px;
        }
        .legend-title {
            font-size: 0.85em;
            color: #e94560;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.8em;
        }
        .legend-color {
            width: 20px;
            height: 12px;
            margin-right: 8px;
            border-radius: 2px;
        }
        .legend-gradient {
            margin-bottom: 10px;
        }
        .gradient-bar {
            height: 15px;
            background: linear-gradient(to right, #1a9850, #66bd63, #a6d96a, #d9ef8b, #fee08b, #fdae61, #f46d43, #d73027, #a50026);
            border-radius: 3px;
        }
        .gradient-bar.hydro-gradient {
            background: linear-gradient(to right, #87CEEB, #5BA3C6, #2F78A1, #1E5A7C, #0D3C57, #00008B);
        }
        .gradient-bar.viridis-gradient {
            background: linear-gradient(to right, #440154, #482878, #3e4989, #31688e, #26828e, #1f9e89, #35b779, #6ece58, #b4de2c, #fde725);
        }
        .map-legend {
            background: rgba(22, 33, 62, 0.92);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }
        .map-legend h4 {
            margin: 0 0 6px 0;
            font-size: 11px;
            color: #e94560;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .map-legend .gradient-bar {
            height: 10px;
            width: 120px;
            border-radius: 2px;
        }
        .map-legend .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #a0a0c0;
            margin-top: 2px;
        }
        .map-legend + .map-legend {
            margin-top: 8px;
        }
        .leaflet-bottom.leaflet-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: #a0a0c0;
            margin-top: 3px;
        }
        #info-panel {
            margin-top: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
            display: none;
        }
        #info-panel.active {
            display: block;
        }
        #info-panel h4 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #e94560;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #0f3460;
            font-size: 0.85em;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #a0a0c0;
        }
        .info-value {
            font-weight: 500;
        }
        .risk-high { color: #e94560; }
        .risk-medium { color: #f39c12; }
        .risk-low { color: #27ae60; }
        .stats-box {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .stat {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #e94560;
        }
        .stat-label {
            font-size: 0.75em;
            color: #a0a0c0;
            margin-top: 4px;
        }
        .leaflet-popup-content-wrapper {
            background: #16213e;
            color: #fff;
            border-radius: 8px;
        }
        .leaflet-popup-tip {
            background: #16213e;
        }
        .popup-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #e94560;
        }
        .popup-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
        }
        .popup-label {
            color: #a0a0c0;
        }
        .footer-links {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #0f3460;
            text-align: center;
            font-size: 0.75em;
        }
        .footer-links a {
            color: #6a6a8a;
            text-decoration: none;
        }
        .footer-links a:hover {
            color: #a0a0c0;
        }
        .footer-links .separator {
            margin: 0 8px;
            color: #3a3a5a;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #0f3460;
        }
        .modal h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .modal h3 {
            color: #f39c12;
            margin: 15px 0 8px;
            font-size: 1em;
        }
        .modal p, .modal li {
            color: #a0a0c0;
            font-size: 0.85em;
            line-height: 1.6;
        }
        .modal ul {
            margin-left: 20px;
        }
        .modal a {
            color: #3498db;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #a0a0c0;
            font-size: 1.5em;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #fff;
        }
        .password-form {
            margin-top: 15px;
        }
        .password-form input {
            background: #1a1a2e;
            border: 1px solid #0f3460;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
        }
        .password-form button {
            background: #e94560;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .password-form button:hover {
            background: #c73e54;
        }
        .error-msg {
            color: #e94560;
            font-size: 0.8em;
            margin-top: 8px;
        }
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ðŸŒŠ Austria Drought Risk Map</h1>
        <p>Municipality-level analysis of groundwater, hydropower impact, and drought risk indicators</p>
    </div>
    
    <div id="container">
        <div id="sidebar">
            <div class="stats-box">
                <div class="stat">
                    <div class="stat-value" id="stat-municipalities">-</div>
                    <div class="stat-label">Municipalities</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-hydro">-</div>
                    <div class="stat-label">Hydropower Plants</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-medium">-</div>
                    <div class="stat-label">Medium Risk</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="stat-highrisk">-</div>
                    <div class="stat-label">High Risk</div>
                </div>
            </div>
            
            <div class="layer-group">
                <h3>Map Layers</h3>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-boundaries" checked>
                    <label for="layer-boundaries">Drought Risk</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-hydro" checked>
                    <label for="layer-hydro">Hydropower Plants</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layer-gw">
                    <label for="layer-gw">Groundwater Trends</label>
                </div>
            </div>
            
            
            
            <div id="info-panel">
                <h4 id="info-title">Municipality Info</h4>
                <div id="info-content"></div>
            </div>
            
            <div class="footer-links">
                <a href="#" id="sources-link">Sources & Methods</a>
                <span class="separator">â€¢</span>
                <a href="data/austria_drought_risk.gpkg" download>Download GeoPackage</a>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [47.5, 13.5],
            zoom: 7,
            zoomControl: true
        });
        
        // Dark basemap
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18
        }).addTo(map);
        
        // Add map legends
        const droughtLegend = L.control({ position: 'bottomright' });
        droughtLegend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = `
                <h4>Drought Risk</h4>
                <div class="gradient-bar"></div>
                <div class="gradient-labels">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                </div>
            `;
            return div;
        };
        droughtLegend.addTo(map);
        
        const hydroLegend = L.control({ position: 'bottomright' });
        hydroLegend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = `
                <h4>Hydropower</h4>
                <div class="gradient-bar hydro-gradient"></div>
                <div class="gradient-labels">
                    <span>0</span>
                    <span>375</span>
                    <span>750 MW</span>
                </div>
            `;
            return div;
        };
        hydroLegend.addTo(map);
        
        const gwLegend = L.control({ position: 'bottomright' });
        gwLegend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            div.id = 'gw-legend';
            div.style.display = 'none';
            div.innerHTML = `
                <h4>GW Trend</h4>
                <div class="gradient-bar viridis-gradient"></div>
                <div class="gradient-labels">
                    <span>-60</span>
                    <span>0</span>
                    <span>+30 cm/dec</span>
                </div>
            `;
            return div;
        };
        gwLegend.addTo(map);
        
        // Layer groups
        const hydroLayer = L.layerGroup().addTo(map);
        const boundaryLayer = L.layerGroup().addTo(map);
        const gwLayer = L.layerGroup();
        
        // Risk color function (categorical)
        function getRiskColor(risk) {
            if (risk > 0.7) return '#e94560';
            if (risk > 0.4) return '#f39c12';
            return '#27ae60';
        }
        
        // Choropleth color function (gradient)
        function getChoroplethColor(risk) {
            // Color scale from green (low risk) through yellow/orange to red (high risk)
            if (risk <= 0) return '#1a9850';  // Dark green
            if (risk <= 0.1) return '#66bd63'; // Green
            if (risk <= 0.2) return '#a6d96a'; // Light green
            if (risk <= 0.3) return '#d9ef8b'; // Yellow-green
            if (risk <= 0.4) return '#fee08b'; // Yellow
            if (risk <= 0.5) return '#fdae61'; // Orange
            if (risk <= 0.6) return '#f46d43'; // Dark orange
            if (risk <= 0.7) return '#d73027'; // Red-orange
            if (risk <= 0.8) return '#a50026'; // Dark red
            return '#67001f';  // Very dark red
        }
        
        function getRiskCategory(risk) {
            if (risk > 0.7) return 'High';
            if (risk > 0.4) return 'Medium';
            return 'Low';
        }
        
        // Hydropower color function - continuous blue scale based on power (MW)
        function getHydroColor(mw) {
            // Scale from light blue (low power) to dark blue (high power)
            const maxMW = 750;
            const ratio = Math.min(mw / maxMW, 1);
            
            // Interpolate from light blue (#87CEEB) to dark blue (#00008B)
            const r = Math.round(135 - ratio * 135);
            const g = Math.round(206 - ratio * 156);
            const b = Math.round(235 - ratio * 96);
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // Viridis color scale for groundwater trends
        // Trend range: approximately -0.6 to +0.3 m/decade
        function getViridisColor(trend) {
            // Normalize trend to 0-1 (negative=declining=yellow, positive=rising=purple)
            // We flip it so declining (bad) is yellow/green, rising (good) is purple/blue
            const minTrend = -0.6;
            const maxTrend = 0.3;
            const normalized = (trend - minTrend) / (maxTrend - minTrend);
            const t = Math.max(0, Math.min(1, normalized));
            
            // Viridis colormap approximation
            const viridis = [
                [68, 1, 84],      // 0.0 - dark purple
                [72, 40, 120],    // 0.1
                [62, 74, 137],    // 0.2
                [49, 104, 142],   // 0.3
                [38, 130, 142],   // 0.4
                [31, 158, 137],   // 0.5
                [53, 183, 121],   // 0.6
                [109, 205, 89],   // 0.7
                [180, 222, 44],   // 0.8
                [253, 231, 37]    // 1.0 - yellow
            ];
            
            const idx = t * (viridis.length - 1);
            const i = Math.floor(idx);
            const f = idx - i;
            
            if (i >= viridis.length - 1) return `rgb(${viridis[viridis.length-1].join(',')})`;
            
            const r = Math.round(viridis[i][0] + f * (viridis[i+1][0] - viridis[i][0]));
            const g = Math.round(viridis[i][1] + f * (viridis[i+1][1] - viridis[i][1]));
            const b = Math.round(viridis[i][2] + f * (viridis[i+1][2] - viridis[i][2]));
            
            return `rgb(${r}, ${g}, ${b})`;
        }
        
        // Load data
        let municipalitiesData = [];
        let powerplantsData = [];
        let gwStationsData = [];
        let geojsonData = null;
        
        async function loadData() {
            try {
                const [muniResp, ppResp, gwResp, geoResp] = await Promise.all([
                    fetch('data/municipalities.json'),
                    fetch('data/powerplants.json'),
                    fetch('data/gw_stations_trends.json'),
                    fetch('data/municipalities_risk.geojson')
                ]);
                
                municipalitiesData = await muniResp.json();
                powerplantsData = await ppResp.json();
                gwStationsData = await gwResp.json();
                geojsonData = await geoResp.json();
                
                updateStats();
                renderLayers();
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        function updateStats() {
            document.getElementById('stat-municipalities').textContent = municipalitiesData.length;
            document.getElementById('stat-hydro').textContent = powerplantsData.length;
            
            // Count risk categories
            const highRisk = municipalitiesData.filter(m => m.risk_category === 'high').length;
            const medRisk = municipalitiesData.filter(m => m.risk_category === 'medium').length;
            document.getElementById('stat-medium').textContent = medRisk;
            document.getElementById('stat-highrisk').textContent = highRisk;
        }
        
        function renderLayers() {
            // Clear layers
            hydroLayer.clearLayers();
            boundaryLayer.clearLayers();
            gwLayer.clearLayers();
            
            // Render choropleth - municipalities colored by risk score
            if (geojsonData) {
                L.geoJSON(geojsonData, {
                    style: function(feature) {
                        const risk = feature.properties.risk_score || 0;
                        return {
                            fillColor: getChoroplethColor(risk),
                            fillOpacity: 0.75,
                            color: '#1a1a2e',
                            weight: 0.5
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const risk = props.risk_score || 0;
                        const gwTrend = props.gw_trend ? (props.gw_trend * 100).toFixed(1) + ' cm/dec' : 'N/A';
                        
                        layer.bindTooltip(`
                            <b>${props.name}</b><br>
                            Risk: ${(risk * 100).toFixed(0)}%<br>
                            GW Trend: ${gwTrend}
                        `, { sticky: true });
                        
                        layer.on('click', function() {
                            showMunicipalityInfo(props);
                        });
                        
                        layer.on('mouseover', function() {
                            layer.setStyle({ 
                                fillOpacity: 0.9,
                                weight: 2,
                                color: '#fff'
                            });
                            layer.bringToFront();
                        });
                        
                        layer.on('mouseout', function() {
                            layer.setStyle({ 
                                fillOpacity: 0.75,
                                weight: 0.5,
                                color: '#1a1a2e'
                            });
                        });
                    }
                }).addTo(boundaryLayer);
            }
            
            // Render hydropower plants - uniform size, color by power
            powerplantsData.forEach(pp => {
                const marker = L.circleMarker([pp.lat, pp.lon], {
                    radius: 6,
                    fillColor: getHydroColor(pp.mw || 0),
                    fillOpacity: 0.9,
                    color: '#fff',
                    weight: 1
                });
                
                marker.bindPopup(`
                    <div class="popup-title">${pp.type}</div>
                    <div class="popup-row"><span class="popup-label">Capacity:</span> ${pp.mw} MW</div>
                    <div class="popup-row"><span class="popup-label">River:</span> ${pp.river || 'N/A'}</div>
                    <div class="popup-row"><span class="popup-label">Region:</span> ${pp.region}</div>
                `);
                
                marker.addTo(hydroLayer);
            });
            
            // Render groundwater stations with trend coloring (viridis)
            gwStationsData.forEach(gw => {
                if (!gw.lat || !gw.lon) return;
                const trend = gw.trend_m_per_decade;
                if (trend === undefined || trend === null) return;
                
                const marker = L.circleMarker([gw.lat, gw.lon], {
                    radius: 5,
                    fillColor: getViridisColor(trend),
                    fillOpacity: 0.85,
                    color: '#222',
                    weight: 0.5
                });
                
                const trendCm = (trend * 100).toFixed(1);
                const trendDir = trend < 0 ? 'declining' : 'rising';
                
                marker.bindPopup(`
                    <div class="popup-title">${gw.name || 'GW Station'}</div>
                    <div class="popup-row"><span class="popup-label">Trend:</span> ${trendCm} cm/decade (${trendDir})</div>
                    <div class="popup-row"><span class="popup-label">Data years:</span> ${gw.data_years ? gw.data_years.toFixed(0) : 'N/A'}</div>
                    <div class="popup-row"><span class="popup-label">Mean level:</span> ${gw.mean_level ? gw.mean_level.toFixed(1) + ' m' : 'N/A'}</div>
                `);
                
                marker.addTo(gwLayer);
            });
        }
        
        function showMunicipalityInfo(props) {
            const panel = document.getElementById('info-panel');
            const title = document.getElementById('info-title');
            const content = document.getElementById('info-content');
            
            title.textContent = props.name || 'Unknown';
            
            const riskClass = props.risk_score > 0.7 ? 'risk-high' : 
                             props.risk_score > 0.4 ? 'risk-medium' : 'risk-low';
            
            const gwTrend = props.gw_trend ? (props.gw_trend * 100).toFixed(1) : 'N/A';
            const gwTrendClass = props.gw_trend < 0 ? 'risk-high' : 'risk-low';
            
            content.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Risk Score:</span>
                    <span class="info-value ${riskClass}">${(props.risk_score * 100 || 0).toFixed(1)}%</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Risk Category:</span>
                    <span class="info-value ${riskClass}">${props.risk_category || 'low'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">GW Trend:</span>
                    <span class="info-value ${gwTrendClass}">${gwTrend} cm/decade</span>
                </div>
                <div class="info-row">
                    <span class="info-label">GW Stations:</span>
                    <span class="info-value">${props.gw_stations || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hydro Plants:</span>
                    <span class="info-value">${props.hydro_plants || 0}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hydro Capacity:</span>
                    <span class="info-value">${props.hydro_capacity || 0} MW</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Pump Storage:</span>
                    <span class="info-value">${props.pump_storage || 0} MW</span>
                </div>
            `;
            
            panel.classList.add('active');
        }
        
        // Layer toggle handlers
        document.getElementById('layer-hydro').addEventListener('change', function() {
            if (this.checked) map.addLayer(hydroLayer);
            else map.removeLayer(hydroLayer);
        });
        
        document.getElementById('layer-boundaries').addEventListener('change', function() {
            if (this.checked) map.addLayer(boundaryLayer);
            else map.removeLayer(boundaryLayer);
        });
        
        document.getElementById('layer-gw').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(gwLayer);
                document.getElementById('gw-legend').style.display = 'block';
            } else {
                map.removeLayer(gwLayer);
                document.getElementById('gw-legend').style.display = 'none';
            }
        });
        
        // Load data on page load
        loadData();
        
        // Modal handlers
        document.getElementById('sources-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('sources-modal').classList.add('active');
        });
        
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.modal-overlay').classList.remove('active');
            });
        });
        
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) this.classList.remove('active');
            });
        });
        
        
    </script>
    
    <!-- Sources Modal -->
    <div class="modal-overlay" id="sources-modal">
        <div class="modal">
            <button class="modal-close">&times;</button>
            <h2>Sources & Methods</h2>
            
            <h3>Data Sources</h3>
            <ul>
                <li><a href="https://ehyd.gv.at" target="_blank">eHYD Portal</a> - Austrian hydrographic service
                    <ul>
                        <li>Groundwater levels (2,074 monitoring stations)</li>
                        <li>100+ years of monthly measurements</li>
                    </ul>
                </li>
                <li><a href="https://oesterreichsenergie.at" target="_blank">Oesterreichs Energie</a> - Power plant registry (156 hydropower plants)</li>
                <li>Municipality boundaries from <a href="https://github.com/ginseng666/GeoJSON-TopoJSON-Austria" target="_blank">GeoJSON Austria</a></li>
            </ul>
            
            <h3>Risk Calculation</h3>
            <p>The drought risk score combines:</p>
            <ul>
                <li><b>Groundwater trend (50%)</b>: Linear regression on annual mean water table levels. Negative trends (declining water table) increase risk.</li>
                <li><b>Hydropower impact (50%)</b>: Normalized capacity of nearby hydropower plants. Higher capacity = potentially higher impact on local hydrology.</li>
            </ul>
            
            <h3>Trend Analysis</h3>
            <ul>
                <li>Minimum 10 years of data required</li>
                <li>Outliers filtered (trends > 5m/decade excluded)</li>
                <li>Stations with unrealistic variance excluded</li>
                <li>Result: 94 stations with valid trends</li>
                <li>Finding: 54 declining, 40 rising (mean: -4.7cm/decade)</li>
            </ul>
            
            <h3>Limitations</h3>
            <ul>
                <li>Coordinate transformation (BMN to WGS84) is approximate</li>
                <li>Risk interpolated to municipalities without direct monitoring</li>
                <li>Hydropower impact is proximity-based, not hydrologically modeled</li>
            </ul>
        </div>
    </div>
    
    
</body>
</html>
